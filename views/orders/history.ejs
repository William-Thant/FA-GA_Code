<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Purchases - Isaac's Cardealership</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { 
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      min-height: 100vh;
      color: #ffffff;
    }
    .page-header { 
      background: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #ff3333 100%);
      color: white; 
      padding: 60px 0; 
      margin-bottom: 40px;
      border-bottom: 3px solid #ff3333;
      box-shadow: 0 10px 40px rgba(255, 51, 51, 0.3);
    }
    .page-header h1 {
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 3px;
      font-size: 2.5rem;
      text-shadow: 0 0 20px rgba(255, 51, 51, 0.5);
    }
    .page-header p {
      color: #a8a8a8;
      font-size: 1.1rem;
      letter-spacing: 1px;
    }
    .order-card {
      background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
      border: 2px solid #333;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      padding: 30px;
      margin-bottom: 30px;
      transition: all 0.3s ease;
    }
    .order-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 50px rgba(255, 51, 51, 0.4);
      border-color: #ff3333;
    }
    .order-header {
      border-bottom: 2px solid #ff3333;
      padding-bottom: 20px;
      margin-bottom: 25px;
    }
    .order-id {
      color: #ff3333;
      font-weight: 700;
      font-size: 1.3rem;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .order-date {
      color: #00d4ff;
      font-size: 1rem;
      font-weight: 500;
    }
    .order-total {
      font-size: 1.5rem;
      font-weight: 800;
      color: #ffd700;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }
    .items-table {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #333;
    }
    .items-table thead {
      background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%) !important;
      color: white !important;
    }
    .items-table thead tr {
      background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%) !important;
    }
    .items-table th {
      border: none;
      padding: 15px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.9rem;
      background: transparent !important;
      color: white !important;
    }
    .items-table tbody {
      background: #0a0a0a;
    }
    .items-table tbody tr {
      background: #0a0a0a;
    }
    .items-table td {
      padding: 15px;
      border-bottom: 1px solid #333;
      color: #ffffff;
      background: #0a0a0a;
    }
    .items-table tbody tr:last-child td {
      border-bottom: none;
    }
    .items-table tbody tr:hover {
      background: rgba(255, 51, 51, 0.1);
    }
    .items-table tbody tr:hover td {
      background: rgba(255, 51, 51, 0.1);
    }
    .btn-resend {
      background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
      border: 2px solid #ff3333;
      color: white;
      padding: 10px 25px;
      border-radius: 25px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
    }
    .btn-resend:hover {
      background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
      transform: scale(1.05);
      color: white;
      box-shadow: 0 5px 20px rgba(255, 51, 51, 0.5);
    }
    .empty-state {
      background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
      border: 2px solid #333;
      border-radius: 15px;
      padding: 80px 40px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .empty-state i {
      font-size: 6rem;
      color: #ff3333;
      margin-bottom: 30px;
      filter: drop-shadow(0 0 20px rgba(255, 51, 51, 0.5));
    }
    .empty-state h4 {
      color: #ffffff;
      margin-bottom: 20px;
      font-weight: 700;
      font-size: 1.8rem;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .empty-state h4 {
      color: #ffffff;
      margin-bottom: 20px;
      font-weight: 700;
      font-size: 1.8rem;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .empty-state p {
      color: #a8a8a8;
      font-size: 1.1rem;
    }
    .summary-section {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid #333;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      color: #ffffff;
      font-size: 1.1rem;
    }
    .summary-row.total {
      font-weight: 800;
      font-size: 1.3rem;
      border-top: 2px solid #ff3333;
      padding-top: 15px;
      margin-top: 10px;
      color: #ffd700;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }
    .badge {
      background: #ff3333 !important;
      color: white;
      font-weight: 700;
      padding: 8px 12px;
    }
  </style>
</head>
<body>
<%- include('../partials/navbar') %>

<div class="page-header">
  <div class="container">
    <h1><i class="fas fa-file-invoice"></i> MY PURCHASES</h1>
    <p class="mb-0">View your vehicle purchase history and invoices</p>
  </div>
</div>

<div class="container pb-5">
  <% if (!orders || orders.length === 0) { %>
    <div class="empty-state">
      <i class="fas fa-car"></i>
      <h4>No Purchases Yet</h4>
      <p class="text-muted">You haven't purchased any vehicles yet. Start browsing to see your purchases here!</p>
      <a href="/shop" class="btn btn-resend mt-3">
        <i class="fas fa-car-side"></i> Browse Inventory
      </a>
    </div>
  <% } else { %>
    <% orders.slice().reverse().forEach(function(order) { %>
      <div class="order-card">
        <div class="order-header">
          <div class="row align-items-center">
            <div class="col-md-6">
              <div class="order-id">
                <i class="fas fa-file-invoice"></i> Order #<%= order.orderId %>
              </div>
              <div class="order-date mt-1">
                <i class="far fa-calendar-alt"></i> <%= (new Date(order.orderDate)).toLocaleString() %>
              </div>
            </div>
            <div class="col-md-6 text-md-end mt-3 mt-md-0">
              <div class="order-total mb-2">
                <i class="fas fa-dollar-sign"></i><%= Number(order.total).toFixed(2) %>
              </div>
              <form class="d-inline resend-form" method="POST" action="/resend-receipt">
                <input type="hidden" name="orderId" value="<%= order.orderId %>">
                <button type="submit" class="btn btn-resend">
                  <i class="fas fa-envelope"></i> Resend Receipt
                </button>
              </form>
              <% if (order.refundStatus === 'none' && order.refund_request_count === 0) { %>
                <a href="/orders/<%= order.orderId %>/refund" class="btn btn-resend ms-2">
                  <i class="fas fa-undo"></i> Request Refund
                </a>
              <% } else if (order.refund_request_count > 0 && order.latest_refund_status === 'pending') { %>
                <button class="btn btn-resend ms-2" disabled style="background: linear-gradient(135deg, #666 0%, #444 100%);">
                  <i class="fas fa-clock"></i> Refund Pending
                </button>
              <% } else if (order.refund_request_count > 0 && order.latest_refund_status === 'approved' && order.refundStatus === 'full') { %>
                <button class="btn btn-resend ms-2" disabled style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
                  <i class="fas fa-check-double"></i> Fully Refunded
                </button>
              <% } else if (order.refund_request_count > 0 && order.latest_refund_status === 'approved' && order.refundStatus === 'partial') { %>
                <button class="btn btn-resend ms-2" disabled style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
                  <i class="fas fa-check"></i> Partially Refunded
                </button>
              <% } else if (order.refundStatus === 'partial') { %>
                <button class="btn btn-resend ms-2" disabled style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
                  <i class="fas fa-check"></i> Partially Refunded
                </button>
              <% } else if (order.refundStatus === 'full') { %>
                <button class="btn btn-resend ms-2" disabled style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
                  <i class="fas fa-check-double"></i> Fully Refunded
                </button>
              <% } %>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table items-table mb-0">
            <thead>
              <tr>
                <th><i class="fas fa-car"></i> Vehicle</th>
                <th class="text-center"><i class="fas fa-hashtag"></i> Quantity</th>
                <th class="text-end"><i class="fas fa-tag"></i> Price</th>
                <th class="text-end"><i class="fas fa-calculator"></i> Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <% (order.items || []).forEach(function(it) { %>
                <tr>
                  <td><strong><%= it.productName %></strong></td>
                  <td class="text-center"><span class="badge"><%= it.quantity %></span></td>
                  <td class="text-end">$<%= Number(it.price).toFixed(2) %></td>
                  <td class="text-end"><strong>$<%= (Number(it.price) * Number(it.quantity)).toFixed(2) %></strong></td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>

        <div class="summary-section">
          <% const platformFee = Number(order.subtotal) * 0.10; %>
          <% const expectedTotal = Number(order.subtotal) + Number(order.tax) + platformFee; %>
          <% const showPlatformFee = Math.abs(expectedTotal - Number(order.total)) <= 0.01; %>
          <div class="summary-row">
            <span>Subtotal:</span>
            <span>$<%= Number(order.subtotal).toFixed(2) %></span>
          </div>
          <% if (showPlatformFee) { %>
          <div class="summary-row">
            <span>Platform Fee (10%):</span>
            <span>$<%= platformFee.toFixed(2) %></span>
          </div>
          <% } %>
          <div class="summary-row">
            <span>Tax:</span>
            <span>$<%= Number(order.tax).toFixed(2) %></span>
          </div>
          <% if (order.refundedAmount && order.refundedAmount > 0) { %>
          <div class="summary-row" style="color: #ffc107;">
            <span>Refunded:</span>
            <span>-$<%= Number(order.refundedAmount).toFixed(2) %></span>
          </div>
          <% } %>
          <div class="summary-row total">
            <span>Total:</span>
            <span>$<%= Number(order.total).toFixed(2) %></span>
          </div>
        </div>
      </div>
    <% }); %>
  <% } %>
</div>
</body>
</html>

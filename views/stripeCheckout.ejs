<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stripe Payment - Isaac's Cardealership</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body { 
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      min-height: 100vh;
      color: #ffffff;
    }
    .page-header { 
      background: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #ff3333 100%);
      color: white; 
      padding: 60px 0; 
      margin-bottom: 40px;
      border-bottom: 3px solid #ff3333;
      box-shadow: 0 10px 40px rgba(255, 51, 51, 0.3);
    }
    .page-header h1 {
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 3px;
      text-shadow: 0 0 20px rgba(255, 51, 51, 0.5);
    }
    .payment-container {
      max-width: 600px;
      margin: 0 auto;
      background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
      padding: 40px;
      border-radius: 15px;
      border: 2px solid #333;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    #payment-element {
      margin-bottom: 24px;
    }
    #payment-message {
      color: #a8a8a8;
      font-size: 16px;
      line-height: 20px;
      padding-top: 12px;
      text-align: center;
      font-weight: 600;
    }
    #payment-message.error {
      color: #ff3333;
    }
    #submit-button {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 2px;
      background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
      border: 2px solid #ff3333;
      color: white;
      transition: all 0.3s ease;
    }
    #submit-button:hover:not(:disabled) {
      background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
      transform: scale(1.02);
      box-shadow: 0 10px 30px rgba(255, 51, 51, 0.5);
    }
    #submit-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, .3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .amount-display {
      text-align: center;
      font-size: 2.5rem;
      font-weight: 800;
      color: #ffd700;
      margin-bottom: 30px;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }
    .btn-outline-secondary {
      border: 2px solid #333;
      color: #ffffff !important;
      font-weight: 700;
      background: transparent;
    }
    .btn-outline-secondary:hover {
      background: linear-gradient(135deg, #333 0%, #1a1a1a 100%);
      border-color: #ff3333;
    }
  </style>
</head>
<body>
<%- include('partials/navbar') %>

<div class="page-header">
  <div class="container">
    <h1><i class="fas fa-credit-card"></i> STRIPE PAYMENT</h1>
    <p class="mb-0" style="font-weight: 600; letter-spacing: 1px;">COMPLETE YOUR PURCHASE SECURELY</p>
  </div>
</div>

<div class="container pb-5">
  <div class="payment-container">
    <div class="amount-display">
      Total: $<span id="total-amount"></span>
    </div>
    
    <form id="payment-form">
      <div id="payment-element">
        <!-- Stripe Payment Element will be inserted here -->
      </div>
      <button id="submit-button" class="btn btn-success">
        <span id="button-text">Pay Now</span>
        <span id="spinner" class="spinner d-none"></span>
      </button>
      <div id="payment-message" class="d-none"></div>
    </form>
    
    <div class="text-center mt-4">
      <% if (typeof type !== 'undefined' && type === 'wallet_topup') { %>
        <a href="/wallet/topup" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left"></i> Back to Wallet
        </a>
      <% } else { %>
        <a href="/cart" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left"></i> Back to Cart
        </a>
      <% } %>
    </div>
  </div>
</div>

<script>
  // Get client secret and amount from server render or URL parameters
  const clientSecret = '<%= clientSecret %>';
  const amount = '<%= amount %>';
  const checkoutType = '<%= typeof type !== "undefined" ? type : "order" %>';
  
  if (!clientSecret) {
    window.location.href = checkoutType === 'wallet_topup' ? '/wallet/topup' : '/cart';
  }
  
  // Display amount
  document.getElementById('total-amount').textContent = amount;
  
  // Initialize Stripe
  const stripe = Stripe('<%= process.env.STRIPE_PUBLISHABLE_KEY %>');
  
  // Initialize Stripe Elements
  const elements = stripe.elements({ clientSecret });
  
  // Create and mount the Payment Element
  const paymentElement = elements.create('payment');
  paymentElement.mount('#payment-element');
  
  // Handle form submission
  const form = document.getElementById('payment-form');
  const submitButton = document.getElementById('submit-button');
  const buttonText = document.getElementById('button-text');
  const spinner = document.getElementById('spinner');
  const messageContainer = document.getElementById('payment-message');
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    setLoading(true);
    
    // Confirm the payment
    const { error, paymentIntent } = await stripe.confirmPayment({
      elements,
      confirmParams: {
        return_url: window.location.origin + '/stripe/return',
      },
      redirect: 'if_required'
    });
    
    if (error) {
      // Payment failed
      showMessage(error.message, 'error');
      setLoading(false);
    } else if (paymentIntent && paymentIntent.status === 'succeeded') {
      // Payment succeeded
      // Confirm payment on server
      try {
        const response = await fetch('/api/stripe/confirm-payment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ paymentIntentId: paymentIntent.id })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Redirect to success page
          window.location.href = data.redirectUrl;
        } else {
          showMessage(data.error || 'Payment processing failed', 'error');
          setLoading(false);
        }
      } catch (err) {
        console.error('Error confirming payment:', err);
        showMessage('An error occurred while processing your payment', 'error');
        setLoading(false);
      }
    } else {
      showMessage('Payment status: ' + paymentIntent.status, 'error');
      setLoading(false);
    }
  });
  
  function setLoading(isLoading) {
    if (isLoading) {
      submitButton.disabled = true;
      buttonText.classList.add('d-none');
      spinner.classList.remove('d-none');
    } else {
      submitButton.disabled = false;
      buttonText.classList.remove('d-none');
      spinner.classList.add('d-none');
    }
  }
  
  function showMessage(message, type = 'info') {
    messageContainer.classList.remove('d-none');
    messageContainer.textContent = message;
    if (type === 'error') {
      messageContainer.classList.add('error');
    } else {
      messageContainer.classList.remove('error');
    }
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

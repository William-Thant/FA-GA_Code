<!DOCTYPE html>
<html>
<head>
  <title>Top Up Wallet - Isaac's Cardealership</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/theme.css">
  <style>
    body { 
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      min-height: 100vh;
      color: #ffffff;
    }
    .page-header {
      background: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #ff3333 100%);
      color: white;
      padding: 60px 0;
      margin-bottom: 40px;
      border-bottom: 3px solid #ff3333;
      box-shadow: 0 10px 40px rgba(255, 51, 51, 0.3);
    }
    h2 {
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 3px;
      font-size: 2.5rem;
      text-shadow: 0 0 20px rgba(255, 51, 51, 0.5);
      margin-bottom: 30px;
    }
    .card {
      background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
      border: 2px solid #333;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      margin-bottom: 30px;
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 50px rgba(255, 51, 51, 0.3);
      border-color: #ff3333;
    }
    .card-body {
      color: #ffffff;
      padding: 30px;
    }
    .card-header {
      background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
      border-bottom: 2px solid #ff3333;
      color: white;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      border-radius: 13px 13px 0 0 !important;
      padding: 20px;
    }
    .card-header h5 {
      margin: 0;
      font-size: 1.2rem;
    }
    .text-success {
      color: #ffd700 !important;
      font-weight: 800 !important;
      font-size: 2.5rem !important;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.5) !important;
    }
    .text-muted {
      color: #a8a8a8 !important;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-size: 1rem;
    }
    .form-label {
      color: #ffffff;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
    }
    .btn-outline-primary {
      border: 2px solid #ff3333;
      color: #ff3333;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      background: transparent;
    }
    .btn-outline-primary:hover,
    .btn-outline-primary.active {
      background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
      border-color: #ff3333;
      color: white;
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(255, 51, 51, 0.5);
    }
    .btn-outline-dark,
    .payment-method {
      border: 2px solid #333;
      color: #ffffff;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
    }
    .btn-outline-dark:hover,
    .payment-method:hover {
      background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
      border-color: #ff3333;
      color: white !important;
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(255, 51, 51, 0.5);
    }
    .form-control {
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid #333;
      color: #ffffff;
      padding: 12px;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .form-control:focus {
      background: rgba(0, 0, 0, 0.7);
      border-color: #ff3333;
      color: #ffffff;
      box-shadow: 0 0 20px rgba(255, 51, 51, 0.3);
    }
    .form-control::placeholder {
      color: #666;
    }
    .input-group-text {
      background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
      border: 2px solid #ff3333;
      color: white;
      font-weight: 800;
      font-size: 1.2rem;
    }
    .alert-info {
      background: rgba(0, 212, 255, 0.1);
      border: 2px solid #00d4ff;
      color: #00d4ff;
      border-radius: 10px;
      padding: 20px;
      font-weight: 600;
    }
    .alert-info i {
      font-size: 1.3rem;
      margin-right: 10px;
    }
    small.text-muted {
      font-size: 0.85rem;
      text-transform: none;
      letter-spacing: 0;
      font-weight: 500;
    }
    #paypal-button-container {
      max-width: 750px;
      margin: 0 auto;
    }
    #paypal-button-container > div {
      width: 100% !important;
    }
  </style>
</head>
<body>
  <%- include('../partials/navbar') %>
  
  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <h2 class="mb-4"><i class="fas fa-wallet"></i> TOP UP WALLET</h2>
        
        <%- include('../partials/messages') %>
        
        <!-- Current Balance Card -->
        <div class="card mb-4">
          <div class="card-body text-center">
            <h5 class="text-muted">Current Balance</h5>
            <h2 class="text-success mb-0">$<%= walletBalance.toFixed(2) %></h2>
          </div>
        </div>

        <!-- Top Up Form -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Add Funds to Wallet</h5>
          </div>
          <div class="card-body">
            <form id="topupForm">
              <div class="mb-3">
                <label class="form-label"><i class="fas fa-dollar-sign"></i> Select Amount</label>
                <div class="row g-2">
                  <div class="col-6 col-md-3">
                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="1000">$1,000</button>
                  </div>
                  <div class="col-6 col-md-3">
                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="5000">$5,000</button>
                  </div>
                  <div class="col-6 col-md-3">
                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="10000">$10,000</button>
                  </div>
                  <div class="col-6 col-md-3">
                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="50000">$50,000</button>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label"><i class="fas fa-edit"></i> Or Enter Custom Amount</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" class="form-control" id="customAmount" 
                         min="10" max="100000" step="0.01" placeholder="10 - 100,000">
                </div>
                <small class="text-muted">Minimum: $10 | Maximum: $100,000</small>
              </div>

              <div class="mb-4">
                <label class="form-label"><i class="fas fa-credit-card"></i> Payment Method</label>
                <div class="row g-3">
                  <div class="col-md-4">
                    <button type="button" class="btn btn-outline-dark w-100 payment-method" data-method="stripe">
                      <i class="fab fa-stripe"></i> Stripe
                    </button>
                  </div>
                  <div class="col-md-4">
                    <button type="button" class="btn btn-outline-dark w-100 payment-method" data-method="paypal">
                      <i class="fab fa-paypal"></i> PayPal
                    </button>
                  </div>
                  <div class="col-md-4">
                    <button type="button" class="btn btn-outline-dark w-100 payment-method" data-method="nets">
                      <i class="fas fa-qrcode"></i> NETS
                    </button>
                  </div>
                </div>
              </div>

              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Funds will be instantly added to your wallet after successful payment.
              </div>
            </form>
          </div>
        </div>

        <!-- PayPal Button Container (Hidden by default) -->
        <div class="card mt-3" id="paypal-card" style="display: none;">
          <div class="card-header">
            <h5 class="mb-0"><i class="fab fa-paypal"></i> Complete PayPal Payment</h5>
          </div>
          <div class="card-body">
            <div id="paypal-button-container"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.paypal.com/sdk/js?client-id=<%= process.env.PAYPAL_CLIENT_ID %>&currency=SGD"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    let selectedAmount = 0;
    let selectedMethod = '';

    // Amount button selection
    document.querySelectorAll('.amount-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        selectedAmount = parseFloat(this.dataset.amount);
        document.getElementById('customAmount').value = '';
      });
    });

    // Custom amount input
    document.getElementById('customAmount').addEventListener('input', function() {
      document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
      selectedAmount = parseFloat(this.value) || 0;
    });

    // Payment method selection
    document.querySelectorAll('.payment-method').forEach(btn => {
      btn.addEventListener('click', function() {
        if (selectedAmount < 10 || selectedAmount > 100000) {
          alert('Please select an amount between $10 and $100,000');
          return;
        }

        selectedMethod = this.dataset.method;
        
        if (selectedMethod === 'stripe') {
          processStripeTopup();
        } else if (selectedMethod === 'paypal') {
          showPayPalButtons();
        } else if (selectedMethod === 'nets') {
          processNetsTopup();
        }
      });
    });

    function processStripeTopup() {
      window.location.href = `/wallet/topup/stripe?amount=${selectedAmount}`;
    }

    let paypalRendered = false;
    
    function showPayPalButtons() {
      const container = document.getElementById('paypal-button-container');
      const card = document.getElementById('paypal-card');
      
      // Prevent duplicate rendering
      if (paypalRendered) {
        card.style.display = 'block';
        card.scrollIntoView({ behavior: 'smooth' });
        return;
      }
      
      container.innerHTML = '';
      card.style.display = 'block';
      card.scrollIntoView({ behavior: 'smooth' });

      paypal.Buttons({
        createOrder: function(data, actions) {
          return fetch('/api/paypal/create-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              amount: selectedAmount.toFixed(2), 
              currency: 'SGD',  // Default to SGD
              type: 'wallet_topup' 
            })
          })
          .then(res => res.json())
          .then(order => order.id);
        },
        onApprove: function(data, actions) {
          return fetch('/wallet/topup/paypal/capture', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderID: data.orderID, amount: selectedAmount })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              window.location.href = '/wallet/topup/success?amount=' + selectedAmount;
            } else {
              alert('Top-up failed: ' + (data.error || 'Unknown error'));
            }
          });
        }
      }).render('#paypal-button-container');
      
      paypalRendered = true;
    }

    function processNetsTopup() {
      window.location.href = `/wallet/topup/nets?amount=${selectedAmount}`;
    }
  </script>
</body>
</html>
